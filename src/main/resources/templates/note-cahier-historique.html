<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: headerParams('Historique - Cahier de Texte - UASZ')}"></head>

<body>

<nav th:replace="~{fragments/layout :: sidebar(activePage='cahier')}"></nav>

<main class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark">Historique des Modifications</h2>
            <p class="text-muted mb-0">Suivi complet des changements apportés à la note</p>
        </div>
        <div>
            <a th:if="${note != null && !note.estValide}" href="/edit-note-cahier/" th:href="@{/edit-note-cahier/{id}(id=${note.id})}" class="btn btn-primary shadow-sm me-2">
                <i class="bi bi-pencil me-2"></i>Modifier la note
            </a>
            <a href="/lst-notes-cahier" th:href="@{/lst-notes-cahier}" class="btn btn-outline-secondary shadow-sm">
                <i class="bi bi-arrow-left me-2"></i>Retour
            </a>
        </div>
    </div>

    <!-- Message d'erreur -->
    <div th:if="${error != null}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Informations de la note -->
    <div th:if="${note != null}" class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="bi bi-journal-text me-2"></i>
                <span th:text="${note.titre}">Titre de la note</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Séance :</strong>
                        <span th:if="${note.seance != null}" th:text="${note.seance.titre}">Séance</span>
                        <span th:unless="${note.seance != null}">-</span>
                    </p>
                    <p><strong>Date de création :</strong>
                        <span th:text="${#temporals.format(note.dateCreation, 'dd/MM/yyyy HH:mm')}">Date</span>
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>Dernière modification :</strong>
                        <span th:text="${#temporals.format(note.dateModification, 'dd/MM/yyyy HH:mm')}">Date</span>
                    </p>
                    <p><strong>Statut :</strong>
                        <span th:if="${note.estValide}" class="badge bg-success">Validée</span>
                        <span th:unless="${note.estValide}" class="badge bg-warning text-dark">En attente</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline des modifications -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>Historique complet des modifications
            </h5>
        </div>
        <div class="card-body">
            <div th:if="${historique == null or historique.isEmpty()}" class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucune modification enregistrée</p>
            </div>

            <div th:if="${historique != null and !historique.isEmpty()}" class="timeline">
                <div th:each="hist : ${historique}" class="timeline-item">
                    <div class="timeline-marker"
                         th:classappend="${hist.typeModification == 'CREATION'} ? 'creation' : (${hist.typeModification == 'VALIDATION'} ? 'validation' : '')"></div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge"
                                      th:classappend="${hist.typeModification == 'CREATION'} ? 'bg-success' : (${hist.typeModification == 'VALIDATION'} ? 'bg-warning text-dark' : 'bg-primary')"
                                      th:text="${hist.typeModification}">MODIFICATION</span>
                                <small class="text-muted">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    <span th:text="${#temporals.format(hist.dateModification, 'dd/MM/yyyy HH:mm:ss')}">Date</span>
                                </small>
                            </div>

                            <div class="mb-2">
                                <strong>Champ modifié :</strong>
                                <span class="badge bg-secondary" th:text="${hist.champModifie}">titre</span>
                            </div>

                            <div class="row">
                                <div class="col-md-6" th:if="${hist.ancienneValeur != null and !hist.ancienneValeur.isEmpty()}">
                                    <small class="text-muted"><strong>Ancienne valeur :</strong></small>
                                    <div class="alert alert-light mb-0 mt-1">
                                        <span th:text="${hist.ancienneValeur}">Ancienne valeur</span>
                                    </div>
                                </div>
                                <div class="col-md-6" th:if="${hist.nouvelleValeur != null and !hist.nouvelleValeur.isEmpty()}">
                                    <small class="text-success"><strong>Nouvelle valeur :</strong></small>
                                    <div class="alert alert-success mb-0 mt-1">
                                        <span th:text="${hist.nouvelleValeur}">Nouvelle valeur</span>
                                    </div>
                                </div>
                            </div>

                            <div th:if="${hist.enseignantModificateur != null}" class="mt-2">
                                <small class="text-info">
                                    <i class="bi bi-person-circle me-1"></i>
                                    Modifié par :
                                    <strong th:text="${hist.enseignantModificateur.nom + ' ' + hist.enseignantModificateur.prenom}">Enseignant</strong>
                                </small>
                            </div>

                            <div th:if="${hist.commentaire != null and !hist.commentaire.isEmpty()}" class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-chat-left-text me-1"></i>
                                    Commentaire : <span th:text="${hist.commentaire}">Commentaire</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${historique != null and !historique.isEmpty()}" class="mt-4 text-center">
                <p class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong th:text="${historique.size()}">0</strong> modification(s) enregistrée(s)
                </p>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
